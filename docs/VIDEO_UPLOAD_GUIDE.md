# 🎥 自建视频服务器使用指南

## 📋 **系统概述**

您的视频平台现在支持完整的自建视频存储功能，包括：

- ✅ 视频文件上传和存储
- ✅ 缩略图自动处理
- ✅ 视频信息提取
- ✅ Web 优化格式转换
- ✅ 进度跟踪和错误处理

## 🚀 **快速开始**

### 1. **访问管理页面**
```
http://localhost:3000/admin/video-management
```

### 2. **上传视频**
1. 点击"上传视频"标签
2. 拖拽或点击上传视频文件
3. 可选：上传自定义缩略图
4. 填写视频信息（标题、描述、分类）
5. 点击"创建视频"

## 📁 **文件存储结构**

```
public/
├── uploads/
│   ├── videos/          # 视频文件存储
│   │   ├── 1234567890_video.mp4
│   │   └── 1234567891_lesson1.mp4
│   └── thumbnails/      # 缩略图存储
│       ├── 1234567890_thumbnail.webp
│       └── 1234567891_thumbnail.webp
```

## 🎯 **支持的格式**

### 视频格式
- **MP4** (推荐)
- **WebM**
- **QuickTime (.mov)**
- **AVI**

### 图片格式 (缩略图)
- **JPEG**
- **PNG**
- **WebP**

## ⚙️ **配置参数**

### 上传限制
- **视频文件**: 最大 500MB
- **缩略图**: 最大 10MB
- **缩略图尺寸**: 自动调整为 800x450 (16:9)

### API 端点
- **视频上传**: `POST /api/upload/video`
- **缩略图上传**: `POST /api/upload/thumbnail`

## 🔧 **高级功能**

### 自动缩略图生成
如果不上传缩略图，系统会：
1. 使用默认占位图
2. 或者从视频第1秒提取帧作为缩略图

### 视频处理
系统支持以下处理功能：
- 获取视频信息（时长、分辨率等）
- 生成缩略图
- 格式转换
- 压缩优化

## 📊 **存储管理**

### 文件命名规则
- **时间戳_原文件名**: `1694876543_my_video.mp4`
- **自动清理**: 支持定期清理未使用的文件

### 访问URL格式
```
视频: /uploads/videos/1694876543_video.mp4
缩略图: /uploads/thumbnails/1694876543_thumbnail.webp
```

## 🛠️ **故障排除**

### 常见问题

1. **上传失败**
   - 检查文件大小是否超限
   - 确认文件格式是否支持
   - 检查磁盘空间

2. **视频无法播放**
   - 确认文件完整性
   - 检查浏览器兼容性
   - 尝试转换为 MP4 格式

3. **缩略图不显示**
   - 检查图片文件路径
   - 确认图片格式支持
   - 查看浏览器控制台错误

### 日志查看
```bash
# 查看 Next.js 服务器日志
npm run dev

# 检查上传目录权限
ls -la public/uploads/
```

## 🔐 **安全考虑**

### 文件验证
- ✅ MIME 类型检查
- ✅ 文件大小限制
- ✅ 管理员权限验证
- ✅ 文件名安全处理

### 建议设置
1. 设置适当的文件权限
2. 定期备份上传文件
3. 监控磁盘使用量
4. 配置防病毒扫描

## 📈 **性能优化**

### 建议配置
```javascript
// next.config.ts
const nextConfig = {
  experimental: {
    serverComponentsExternalPackages: ['sharp', 'fluent-ffmpeg']
  }
}
```

### CDN 集成
考虑将静态文件迁移到 CDN：
- AWS S3 + CloudFront
- Vercel Blob Storage
- Cloudinary

## 🔄 **升级路径**

### 云存储迁移
1. **AWS S3**
2. **Google Cloud Storage**
3. **Azure Blob Storage**
4. **Vercel Blob**

### 流媒体服务
1. **HLS 切片**
2. **DASH 流媒体**
3. **自适应码率**

## 📞 **技术支持**

如需帮助，请检查：
1. 服务器日志
2. 浏览器控制台
3. 文件权限设置
4. 磁盘空间使用

---

**最后更新**: 2024年9月16日
